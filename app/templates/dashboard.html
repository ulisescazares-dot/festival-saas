<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Panel Organizador</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f4f6f9; }
.card { border:none; border-radius:14px; box-shadow:0 4px 14px rgba(0,0,0,0.06); }
.badge-signed { background:#198754; }
.badge-pending { background:#dc3545; }
.badge-doc { background:#0d6efd; }
.header-title { font-weight:700; font-size:22px; }
</style>

</head>
<body>

<div class="container py-4">

<!-- ================= HEADER ================= -->

<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="header-title">Panel Organizador</div>
    <button class="btn btn-dark" onclick="loadData()">Actualizar</button>
</div>

<!-- ================= DASHBOARD EXPOSITORES ================= -->

<div class="card p-3 mb-5">
<div class="table-responsive">
<table class="table align-middle">
<thead>
<tr>
<th>Festival</th>
<th>Evento</th>
<th>Expositor</th>
<th>Email</th>
<th>Firma</th>
<th>El√©ctrico</th>
<th>Docs</th>
<th>PDF</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>
</div>

<hr class="my-5">

<!-- ================= CREAR FESTIVAL ================= -->

<div class="card p-4 mb-4">
<h5 class="mb-3">Crear Festival</h5>

<div class="row g-2">
    <div class="col-md-5">
        <input type="text" id="festival_name" class="form-control" placeholder="Nombre del festival">
    </div>
    <div class="col-md-5">
        <input type="text" id="festival_description" class="form-control" placeholder="Descripci√≥n">
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary w-100" onclick="createFestival()">Crear</button>
    </div>
</div>
</div>

<!-- ================= LISTA FESTIVALES ================= -->

<div class="card p-4">
<h5 class="mb-3">Mis Festivales</h5>
<div id="festival_list"></div>
</div>

</div>

<script>

async function loadData() {

    const token = localStorage.getItem("access_token");

    const response = await fetch("/agreements/dashboard", {
        headers: { "Authorization": "Bearer " + token }
    });

    if(!response.ok){
        alert("No autorizado. Inicia sesi√≥n nuevamente.");
        return;
    }

    const data = await response.json();
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    data.rows.forEach(row => {

        const tr = document.createElement("tr");

        const signedBadge = row.signed
            ? `<span class="badge badge-signed">Firmado</span>`
            : `<span class="badge badge-pending">Pendiente</span>`;

        const electrical = row.total_amperage
            ? `${row.total_amperage}A / ${row.voltage}V`
            : "-";

        const docsBadge = row.documents > 0
            ? `<span class="badge badge-doc">${row.documents}</span>`
            : "-";

        const pdfBtn = row.signed
            ? `<a class="btn btn-sm btn-outline-dark" href="${row.pdf_url}" target="_blank">Ver PDF</a>`
            : "-";

        tr.innerHTML = `
            <td>${row.festival}</td>
            <td>${row.event}</td>
            <td><strong>${row.business_name || ""}</strong></td>
            <td>${row.email || ""}</td>
            <td>${signedBadge}</td>
            <td>${electrical}</td>
            <td>${docsBadge}</td>
            <td>${pdfBtn}</td>
        `;

        tbody.appendChild(tr);
    });
}

async function createFestival() {

    const token = localStorage.getItem("access_token");

    const res = await fetch("/festivals", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
            name: document.getElementById("festival_name").value,
            description: document.getElementById("festival_description").value
        })
    });

    if(res.status === 201){
        alert("Festival creado üéâ");
        loadFestivals();
    }
}

async function loadFestivals(){

    const token = localStorage.getItem("access_token");

    const res = await fetch("/festivals", {
        headers: { "Authorization": "Bearer " + token }
    });

    if(!res.ok) return;

    const festivals = await res.json();
    const container = document.getElementById("festival_list");
    container.innerHTML = "";

    festivals.forEach(f => {

        container.innerHTML += `
            <div class="border rounded p-3 mb-3">
                <strong>${f.name}</strong>

                <div class="row g-2 mt-3">
                    <div class="col-md-4">
                        <input type="text" id="contest_name_${f.id}" class="form-control" placeholder="Nombre del concurso">
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="contest_desc_${f.id}" class="form-control" placeholder="Descripci√≥n">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-success w-100" onclick="createContest(${f.id})">
                            Crear Concurso
                        </button>
                    </div>
                </div>

                <div id="contest_list_${f.id}" class="mt-3"></div>
            </div>
        `;

        loadContests(f.id);
    });
}

async function createContest(festivalId){

    const token = localStorage.getItem("access_token");

    const res = await fetch("/admin/contests", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
            festival_id: festivalId,
            name: document.getElementById("contest_name_" + festivalId).value,
            description: document.getElementById("contest_desc_" + festivalId).value
        })
    });

    if(res.status === 201){
        alert("Concurso creado üéâ");
        loadContests(festivalId);
    }
}

async function loadContests(festivalId){

    const token = localStorage.getItem("access_token");

    const res = await fetch(`/festivals/${festivalId}/contests`, {
        headers: { "Authorization": "Bearer " + token }
    });

    if(!res.ok) return;

    const contests = await res.json();
    const container = document.getElementById("contest_list_" + festivalId);
    container.innerHTML = "";

    contests.forEach(c => {
        container.innerHTML += `
            <div class="d-flex justify-content-between border p-2 rounded mb-2">
                <div><strong>${c.name}</strong></div>
                <div>
                    <a href="/public/contest/${c.slug}" target="_blank" class="btn btn-sm btn-outline-primary">P√°gina</a>
                    <a href="/public/contest/${c.slug}/qr" target="_blank" class="btn btn-sm btn-outline-dark">QR</a>
                </div>
            </div>
        `;
    });
}

loadData();
loadFestivals();

</script>

</body>
</html>