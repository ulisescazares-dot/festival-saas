<!DOCTYPE html>
<html>
<head>
    <title>Festival SaaS - Panel</title>
    <style>
        body { font-family: Arial; background: #f3f4f6; margin: 0; }
        header {
            background: #111827;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .actions {
            padding:20px;
            display:flex;
            gap:10px;
            flex-wrap:wrap;
        }

        button {
            background: #2563eb;
            border: none;
            padding: 10px 15px;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }

        button.logout {
            background:#ef4444;
        }

        table {
            width: 95%;
            margin: 30px auto;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }

        th { background: #e5e7eb; }

        .signed { color: green; font-weight: bold; }
        .pending { color: red; font-weight: bold; }

        .card {
            background:white;
            padding:20px;
            margin:20px;
            border-radius:8px;
        }

        input, select {
            padding:8px;
            margin:5px 0;
            width:100%;
        }
    </style>
</head>
<body>

<header>
    <h2>Festival SaaS - Panel Administrador</h2>
    <button class="logout" onclick="logout()">Cerrar sesión</button>
</header>

<div class="actions">
    <button onclick="showFestivalForm()">Crear Festival</button>
    <button onclick="showContestForm()">Crear Concurso</button>
    <button onclick="loadContests()">Ver Concursos</button>
</div>

<div id="dynamicSection"></div>

<hr>

<h3 style="margin-left:20px;">Expositores</h3>

<div id="metrics" style="display:flex; gap:20px; margin:20px;"></div>

<table>
    <thead>
        <tr>
            <th>Festival</th>
            <th>Evento</th>
            <th>Negocio</th>
            <th>Email</th>
            <th>Estado</th>
            <th>PDF</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}
async function showFestivalForm() {
    document.getElementById("dynamicSection").innerHTML = `
        <div class="card">
            <h3>Crear Festival</h3>
            <input id="festivalName" placeholder="Nombre del festival">
            <input id="festivalDesc" placeholder="Descripción">
            <button onclick="createFestival()">Guardar</button>
        </div>
    `;
}

async function createFestival() {

    const csrf = getCookie("csrf_access_token");

    const name = document.getElementById("festivalName").value;
    const description = document.getElementById("festivalDesc").value;

    const res = await fetch("/festivals", {
        method: "POST",
        credentials: "include",
        headers: { 
            "Content-Type": "application/json",
            "X-CSRF-TOKEN": csrf
        },
        body: JSON.stringify({ name, description })
    });

    if(res.ok){
        alert("Festival creado");
    } else {
        alert("Error creando festival");
    }
}

async function showContestForm() {
    document.getElementById("dynamicSection").innerHTML = `
        <div class="card">
            <h3>Crear Concurso</h3>
            <input id="festivalId" placeholder="Festival ID">
            <input id="contestName" placeholder="Nombre del concurso">
            <input id="contestDesc" placeholder="Descripción">
            <button onclick="createContest()">Guardar</button>
        </div>
    `;
}

async function createContest() {

    const csrf = getCookie("csrf_access_token");

    const festival_id = document.getElementById("festivalId").value;
    const name = document.getElementById("contestName").value;
    const description = document.getElementById("contestDesc").value;

    const res = await fetch("/admin/contests", {
        method: "POST",
        credentials: "include",
        headers: { 
            "Content-Type": "application/json",
            "X-CSRF-TOKEN": csrf
        },
        body: JSON.stringify({
            festival_id,
            name,
            description
        })
    });

    const data = await res.json();

    if(res.ok){
        alert("Concurso creado\n\nLink público:\n" + data.public_url);
    } else {
        alert(data.msg);
    }
}

async function loadContests() {

    const festivalId = prompt("Ingresa el ID del festival");

    const res = await fetch(`/festivals/${festivalId}/contests`);
    const data = await res.json();

    let html = `<div class="card"><h3>Concursos</h3>`;

    data.forEach(c => {
        html += `
            <p>
                <strong>${c.name}</strong><br>
                Público: 
                <a href="/public/contest/${c.slug}" target="_blank">
                    /public/contest/${c.slug}
                </a>
            </p>
        `;
    });

    html += `</div>`;

    document.getElementById("dynamicSection").innerHTML = html;
}

async function loadData() {

    const res = await fetch("/agreements/dashboard");

    if (!res.ok) {
        window.location.href = "/auth/login-page";
        return;
    }

    const response = await res.json();
    const data = response.rows;
    const metrics = response.metrics;
    
    document.getElementById("metrics").innerHTML = `
        <div class="card"><strong>Total:</strong> ${metrics.total_exhibitors}</div>
        <div class="card"><strong>Firmados:</strong> ${metrics.signed}</div>
        <div class="card"><strong>Pendientes:</strong> ${metrics.pending}</div>
        <div class="card"><strong>Amperaje total:</strong> ${metrics.total_amperage} A</div>
    `;

    const tableBody = document.getElementById("tableBody");
    tableBody.innerHTML = "";

    data.forEach(row => {
        tableBody.innerHTML += `
            <tr>
                <td>${row.festival}</td>
                <td>${row.event}</td>
                <td>${row.business_name}</td>
                <td>${row.email}</td>
                <td class="${row.signed ? 'signed' : 'pending'}">
                    ${row.signed ? 'Firmado' : 'Pendiente'}
                </td>
                <td>
                    ${row.pdf_url ? `<a href="${row.pdf_url}" target="_blank">Ver PDF</a>` : '-'}
                </td>
            </tr>
        `;
    });
}

async function logout() {
    await fetch("/auth/logout", { method: "POST" });
    window.location.href = "/auth/login-page";
}

loadData();

</script>

</body>
</html>